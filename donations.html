<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Crossings Analysis - Ecoexist</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        .navbar {
            background: linear-gradient(135deg, #2c5530, #4a7c59);
            border-bottom: 3px solid #1a4a2e;
            padding: 15px 0;
        }

        .navbar-brand {
            font-weight: bold;
            color: white !important;
            font-size: 1.5em;
        }

        .container-fluid {
            padding: 20px;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background: linear-gradient(135deg, #2c5530, #4a7c59);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: bold;
        }

        #map {
            height: 700px;
            border-radius: 0 0 10px 10px;
        }

        .stats-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-left: 4px solid #ff6b35;
        }

        .stats-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c5530;
        }

        .stats-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            flex-direction: column;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2c5530;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-custom {
            background: linear-gradient(135deg, #2c5530, #4a7c59);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
        }

        .btn-custom:hover {
            background: linear-gradient(135deg, #1a4a2e, #2c5530);
            color: white;
        }

        .info-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box h6 {
            color: #856404;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #856404;
            margin: 0;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                üêò Road Crossings Analysis - Ecoexist
            </a>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Info Box -->
        <div class="row">
            <div class="col-12">
                <div class="info-box">
                    <h6>üìç Road Crossing Hotspot Analysis</h6>
                    <p>This map shows where elephants cross roads most frequently. Heat map intensity indicates crossing frequency. Red areas = high crossing activity.</p>
                </div>
            </div>
        </div>

        <!-- Statistics Row -->
        <div class="row">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number" id="totalCrossings">-</div>
                        <div class="stats-label">Total Crossings</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number" id="uniqueLocations">-</div>
                        <div class="stats-label">Unique Locations</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number" id="elephantsTracked">-</div>
                        <div class="stats-label">Elephants Tracked</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <div class="stats-number" id="hotspotCount">-</div>
                        <div class="stats-label">Hotspots</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map Row -->
        <div class="row">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üó∫Ô∏è Road Crossing Locations & Heat Map</h5>
                    </div>
                    <div id="map"></div>
                </div>
            </div>

            <!-- Legend -->
            <div class="col-lg-2">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Legend</h6>
                    </div>
                    <div class="card-body">
                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ff0000;"></div>
                                <span>High Activity</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ffa500;"></div>
                                <span>Medium Activity</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ffff00;"></div>
                                <span>Low Activity</span>
                            </div>
                            <hr>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ff6b35; border: 2px solid white;"></div>
                                <span>Crossing Point</span>
                            </div>
                            <div class="legend-item">
                                <div style="width: 20px; height: 2px; background: #666; margin-right: 10px; margin-left: 2px;"></div>
                                <span>Roads</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-custom w-100 mt-3" onclick="exportData()">
                    üìä Export Data
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 9999;">
        <div class="spinner"></div>
        <p class="mt-3">Analyzing road crossings...</p>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet.heat plugin for heatmap -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- Turf.js for geometric calculations -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let map;
        let allData = [];
        let roadsData = null;
        let crossingPoints = [];
        let heatmapLayer = null;
        let crossingMarkers = [];

        // Elephant names
        const elephantNames = {
            "3839": "Shorobe",
            "5588": "Larry",
            "5589": "Mokolwane",
            "5590": "Ebanaria",
            "5591": "Grand Grey",
            "8537": "Brother",
            "8538": "Bruce",
            "8539": "Raintree",
            "8540": "Art",
            "8542": "Dream",
            "8543": "Queenie"
        };

        // Initialize map
        function initMap() {
            map = L.map('map').setView([-19.5, 23.5], 8);

            // Satellite imagery background
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri',
                maxZoom: 18,
                opacity: 0.7
            }).addTo(map);

            // Add scale
            L.control.scale({
                position: 'bottomleft',
                metric: true,
                imperial: false
            }).addTo(map);

            console.log('‚úì Map initialized');
        }

        // Load data
        async function loadData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            try {
                // Load elephant movement data from API
                console.log('Loading elephant movement data from API...');
                const response = await fetch('https://ecoexist-api.vercel.app/api/awt-data-public');
                
                if (!response.ok) {
                    throw new Error(`Failed to load movement data: ${response.status} - ${response.statusText}`);
                }
                
                allData = await response.json();
                console.log(`‚úì Loaded ${allData.length} movement records`);

                // Load roads data - try multiple possible paths
                console.log('Loading roads data...');
                let roadsLoaded = false;
                const roadsPaths = [
                    'data/Roads.geojson',
                    './data/Roads.geojson',
                    '../data/Roads.geojson',
                    'Roads.geojson'
                ];

                for (const path of roadsPaths) {
                    try {
                        console.log(`Trying to load roads from: ${path}`);
                        const roadsResponse = await fetch(path);
                        if (roadsResponse.ok) {
                            roadsData = await roadsResponse.json();
                            console.log(`‚úì Loaded ${roadsData.features.length} road segments from ${path}`);
                            roadsLoaded = true;
                            break;
                        }
                    } catch (e) {
                        console.log(`Failed to load from ${path}: ${e.message}`);
                    }
                }

                if (!roadsLoaded) {
                    throw new Error('Could not load Roads.geojson file. Please ensure the file exists in the data/ folder and you are running this from a web server (not file://).');
                }

                // Calculate road crossings
                calculateRoadCrossings();

                // Display on map
                displayRoads();
                displayCrossings();

                // Update statistics
                updateStatistics();

            } catch (error) {
                console.error('Error loading data:', error);
                
                let errorMessage = 'Failed to load data:\n\n' + error.message;
                
                if (error.message.includes('Roads.geojson')) {
                    errorMessage += '\n\nüí° Solution: You need to run this from a web server, not by opening the file directly.\n\nQuick fix:\n1. Open terminal in this folder\n2. Run: python3 -m http.server 8000\n3. Open: http://localhost:8000/road_crossings.html';
                }
                
                alert(errorMessage);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // Calculate road crossings
        function calculateRoadCrossings() {
            console.log('Calculating road crossings...');
            crossingPoints = [];

            // Group movement data by tag
            const dataByTag = {};
            allData.forEach(item => {
                const tagId = item.tagId || item.tag_id;
                if (!dataByTag[tagId]) {
                    dataByTag[tagId] = [];
                }
                dataByTag[tagId].push(item);
            });

            // For each elephant, create line segments between consecutive points
            Object.keys(dataByTag).forEach(tagId => {
                const tagData = dataByTag[tagId].sort((a, b) => a.timestamp - b.timestamp);
                
                // Create line segments between consecutive points
                for (let i = 0; i < tagData.length - 1; i++) {
                    const point1 = tagData[i];
                    const point2 = tagData[i + 1];
                    
                    const movementLine = turf.lineString([
                        [point1.longitude, point1.latitude],
                        [point2.longitude, point2.latitude]
                    ]);

                    // Check intersection with each road
                    roadsData.features.forEach(road => {
                        try {
                            const roadGeometry = road.geometry;
                            
                            // Check if road and movement line intersect
                            const intersection = turf.lineIntersect(movementLine, roadGeometry);
                            
                            if (intersection.features.length > 0) {
                                // Found crossing point(s)
                                intersection.features.forEach(point => {
                                    const coords = point.geometry.coordinates;
                                    crossingPoints.push({
                                        lat: coords[1],
                                        lng: coords[0],
                                        tagId: tagId,
                                        elephantName: elephantNames[tagId] || `Tag ${tagId}`,
                                        timestamp: point1.timestamp,
                                        roadName: road.properties.name || 'Unnamed Road'
                                    });
                                });
                            }
                        } catch (error) {
                            // Skip invalid geometries
                        }
                    });
                }
            });

            console.log(`‚úì Found ${crossingPoints.length} road crossings`);
        }

        // Display roads on map
        function displayRoads() {
            L.geoJSON(roadsData, {
                style: {
                    color: '#666',
                    weight: 2,
                    opacity: 0.7
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties && feature.properties.name) {
                        layer.bindPopup(`<strong>Road:</strong> ${feature.properties.name}`);
                    }
                }
            }).addTo(map);

            console.log('‚úì Roads displayed');
        }

        // Display crossings with heatmap and points
        function displayCrossings() {
            if (crossingPoints.length === 0) {
                console.warn('No crossing points to display');
                return;
            }

            // Prepare data for heatmap [lat, lng, intensity]
            const heatmapData = crossingPoints.map(point => [
                point.lat,
                point.lng,
                1.0 // Intensity
            ]);

            // Create heatmap layer
            heatmapLayer = L.heatLayer(heatmapData, {
                radius: 25,
                blur: 15,
                maxZoom: 17,
                max: 1.0,
                gradient: {
                    0.0: 'blue',
                    0.2: 'cyan',
                    0.4: 'lime',
                    0.6: 'yellow',
                    0.8: 'orange',
                    1.0: 'red'
                }
            }).addTo(map);

            console.log('‚úì Heatmap created');

            // Add individual crossing point markers
            crossingPoints.forEach(point => {
                const marker = L.circleMarker([point.lat, point.lng], {
                    radius: 6,
                    fillColor: '#ff6b35',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });

                marker.bindPopup(`
                    <strong>Road Crossing</strong><br>
                    <strong>Elephant:</strong> ${point.elephantName}<br>
                    <strong>Road:</strong> ${point.roadName}<br>
                    <strong>Date:</strong> ${new Date(point.timestamp * 1000).toLocaleDateString()}<br>
                    <strong>Location:</strong> ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}
                `);

                marker.addTo(map);
                crossingMarkers.push(marker);
            });

            console.log(`‚úì ${crossingPoints.length} crossing markers added`);

            // Fit map to crossing points
            if (crossingPoints.length > 0) {
                const bounds = L.latLngBounds(crossingPoints.map(p => [p.lat, p.lng]));
                map.fitBounds(bounds.pad(0.1));
            }
        }

        // Update statistics
        function updateStatistics() {
            // Total crossings
            document.getElementById('totalCrossings').textContent = crossingPoints.length.toLocaleString();

            // Unique locations (within 100m radius)
            const uniqueLocations = getUniqueCrossingLocations(crossingPoints, 0.001); // ~100m
            document.getElementById('uniqueLocations').textContent = uniqueLocations;

            // Elephants tracked
            const uniqueElephants = [...new Set(crossingPoints.map(p => p.tagId))];
            document.getElementById('elephantsTracked').textContent = uniqueElephants.length;

            // Hotspots (locations with 5+ crossings)
            const hotspots = identifyHotspots(crossingPoints, 0.001, 5);
            document.getElementById('hotspotCount').textContent = hotspots;
        }

        // Get unique crossing locations (cluster nearby points)
        function getUniqueCrossingLocations(points, threshold) {
            const clusters = [];
            const used = new Set();

            points.forEach((point, index) => {
                if (used.has(index)) return;

                const cluster = [index];
                used.add(index);

                points.forEach((otherPoint, otherIndex) => {
                    if (used.has(otherIndex)) return;

                    const distance = Math.sqrt(
                        Math.pow(point.lat - otherPoint.lat, 2) +
                        Math.pow(point.lng - otherPoint.lng, 2)
                    );

                    if (distance < threshold) {
                        cluster.push(otherIndex);
                        used.add(otherIndex);
                    }
                });

                clusters.push(cluster);
            });

            return clusters.length;
        }

        // Identify hotspots
        function identifyHotspots(points, threshold, minCrossings) {
            const clusters = [];
            const used = new Set();

            points.forEach((point, index) => {
                if (used.has(index)) return;

                const cluster = [index];
                used.add(index);

                points.forEach((otherPoint, otherIndex) => {
                    if (used.has(otherIndex)) return;

                    const distance = Math.sqrt(
                        Math.pow(point.lat - otherPoint.lat, 2) +
                        Math.pow(point.lng - otherPoint.lng, 2)
                    );

                    if (distance < threshold) {
                        cluster.push(otherIndex);
                        used.add(otherIndex);
                    }
                });

                if (cluster.length >= minCrossings) {
                    clusters.push(cluster);
                }
            });

            return clusters.length;
        }

        // Export data to CSV
        function exportData() {
            if (crossingPoints.length === 0) {
                alert('No data to export');
                return;
            }

            // Create CSV content
            const header = 'Elephant Name,Tag ID,Road Name,Latitude,Longitude,Date,Time\n';
            const rows = crossingPoints.map(point => {
                const date = new Date(point.timestamp * 1000);
                return `${point.elephantName},${point.tagId},${point.roadName},${point.lat.toFixed(6)},${point.lng.toFixed(6)},${date.toLocaleDateString()},${date.toLocaleTimeString()}`;
            }).join('\n');

            const csv = header + rows;

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `road_crossings_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            console.log('‚úì Data exported');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadData();
        });
    </script>
</body>
</html>

